<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>연수자 찾기</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.8.18/themes/base/jquery-ui.css" type="text/css" />
    <link rel="stylesheet" href="/css/modal/mobile/jquery-ui.css">
    <link rel="stylesheet" href="/css/modal/mobile/search-modal.css">
    <link rel="stylesheet" href="/css/mobile/list-mobile.css">
    <link rel="shortcut icon" href="/images/components/favicon-logo-white.png">
</head>
<body>
<header>
    <nav class="header relative flex between">
        <a class="back-or-logout" href="javascript:window.history.back();">
                <span class="go-back">
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="48px" id="Layer_1" style="enable-background:new 0 0 48 48;" version="1.1" viewBox="0 0 512 512" width="48px" xml:space="preserve">
                        <polygon points="352,128.4 319.7,96 160,256 160,256 160,256 319.7,416 352,383.6 224.7,256 " style="     fill: #fff; "/>
                    </svg>
                </span>
        </a>
        <span class="navigation-center">연수자 찾기</span>
        <div></div>
    </nav>
</header>
<div class="header-btn bottom flex between">
    <div><a href="/points/exchange-point-mobile">환전</a></div>
    <div><a href="/applies/list-mobile">홈</a></div>
    <div><a href="#">MY</a> </div>
</div>

<div class="container">
    <div class="inner-container">
<!--        <form action="" id="serach">-->
            <section class="serach-header">
                <div class="serach-box">
                        <span class="text-input-wrap">
                            <input class="text-search-input" autocomplete="off" type="search" readonly>
                            <div class="search-result flex">
                                <span class="date-result result" style="display: none">연수 신청일</span>
                                <span class="location-result result" style="display: none">연수 지역</span>
                            </div>
                        </span>
                    <button class="search-button" type="button">
                        <img src="/images/member/icon_search_active.png" alt="검색" class="search-img">
                    </button>
                </div>
            </section>
            <section class="search-result-section">
                <div class="result-header">
                    <p class="title-wrap result-people">
                        <span th:text="${applyCount}"></span>명의 연수 신청자
<!--                        <span th:text="${applyLength > 0 ? applyLength : 0}">0</span>명의 연수 신청자-->
<!--                        <span th:text="${applies.size() - others > 0 ? applies.size() - others : 0}"></span>명의 연수 신청자-->
<!--                        <span th:text="${applies.size() == null ? 0 : applies.size()}"></span>명의 연수 신청자-->
                        <input type="hidden" id="current-page" value="0">
                    </p>
                </div>
                <!-- 연수자 목록 -->
                <div class="result-beginners">
                    <!--                        &lt;!&ndash; 연수자 1명 &ndash;&gt;-->
                    <!--                        <div class="result-beginner">-->
                    <!--                            <div class="project-status-label">-->
                    <!--                                <div class="status-mark recruiting-mark">신청중</div>-->
                    <!--                                <div class="status-mark new-mark">NEW</div>-->
                    <!--                            </div>-->
                    <!--                            <div class="beginner-title">-->
                    <!--                                <span class="subtitle">-->
                    <!--                                    2023.03.20(월)-->
                    <!--                                </span>-->
                    <!--                            </div>-->
                    <!--                            <div class="beginner-info-box">-->
                    <!--                                <div class="estimated-box">-->
                    <!--                                    <div class="estimated estimated-point">-->
                    <!--                                         <p class="estimated-help-text">-->
                    <!--                                            예상 포인트-->
                    <!--                                         </p>-->
                    <!--                                         <p class="estimated-value">-->
                    <!--                                            100,000-->
                    <!--                                         </p>-->
                    <!--                                    </div>-->
                    <!--                                    <div class="estimated estimated-term">-->
                    <!--                                        <p class="estimated-help-text">-->
                    <!--                                            남은 기간-->
                    <!--                                         </p>-->
                    <!--                                         <p class="estimated-value">-->
                    <!--                                            45일-->
                    <!--                                         </p>-->
                    <!--                                    </div>-->
                    <!--                                </div>-->
                    <!--                                <div class="category-field-box">-->
                    <!--                                    <p class="category-info">-->
                    <!--                                        코스-->
                    <!--                                    </p>-->
                    <!--                                    <div class="pipe"></div>-->
                    <!--                                    <p class="field-info">-->
                    <!--                                        <span th:text="${applies[0].applyCourse}"></span>코스(시내주행)-->
                    <!--                                    </p>-->
                    <!--                                </div>-->
                    <!--                                <div class="license-info-tag">-->
                    <!--                                    <div class="simple-chip">-->
                    <!--                                        초보자-->
                    <!--                                    </div>-->
                    <!--                                    <div class="pipe"></div>-->
                    <!--                                    <div class="driver-info-box">-->
                    <!--                                        <div class="driver-tag">2년차</div>-->
                    <!--                                        <div class="driver-tag">신입</div>-->
                    <!--                                        <div class="driver-tag">장롱</div>-->
                    <!--                                    </div>-->
                    <!--                                </div>-->
                    <!--                                <div class="driver-info-etc">-->
                    <!--                                    <div class="location-tag">-->
                    <!--                                        <span class="driver-location">-->
                    <!--                                            서울특별시-->
                    <!--                                        </span>-->
                    <!--                                    </div>-->
                    <!--                                    <div class="pipe"></div>-->
                    <!--                                    <div class="register-date">-->
                    <!--                                        등록 일자 2023.03.13(월)-->
                    <!--                                    </div>-->
                    <!--                                </div>-->
                    <!--                            </div>-->
                    <!--                            <div class="ok-wrapper">-->
                    <!--                                &lt;!&ndash; <input type="button" class="ok-btn" onclick="acceptOrReject()" value="수락"/> &ndash;&gt;-->
                    <!--                                <button type="button" class="ok-btn" onclick="acceptOrReject(this)">수락</button>-->
                    <!--                            </div>-->
                    <!--                        </div> &lt;!&ndash; 연수자 1명 끝 &ndash;&gt;-->
                </div> <!-- 목록 div 끝 -->
            </section>
<!--        </form>-->
    </div>
    <!--맨위로 가기 버튼-->
    <button class="back-to-top"></button>
    <!--맨위로 가기 버튼-->
    <div class="modal-search-modal" th:fragment="search-modal" style="display: none;">
        <!-- 헤더 -->
        <div class="modal-search-header">
            <div class="modal-close-btn">
                <button type="button" class="modal-close">
                        <span class="modal-close-img">
                            <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="presentation" focusable="false" style="display: block; fill: none; height: 12px; width: 12px; stroke: currentcolor; stroke-width: 5.33333; overflow: visible;">
                                <path d="m6 6 20 20"></path>
                                <path d="m26 6-20 20"></path>
                            </svg>
                        </span>
                </button>
            </div>
            <div class="modal-header-title">
                <span class="modal-title">검색</span>
            </div>
        </div>
        <!-- 메인 -->
        <div class="modal-main-wrapper">
            <div class="modal-inner-wrapper">
                <form action="/applies/list-mobile/search" name="searchForm" method="get">
                    <div class="modal-btn-wrapper">
                        <input  type="text" name="applyDate" id="datepicker" class="modal-btn date-wrapper" autocomplete="off" style="position: absolute; display: block; visibility: visible; width: 100%; opacity: 0; z-index: 2;">
                        <button type="button" class="modal-btn date-wrapper">
                            <span class="modal-subtitle date">날짜</span>
                            <span class="modal-value date-value">날짜 추가</span>
                        </button>
                    </div>
                    <div class="modal-btn-wrapper">
                        <input  type="text" name="applyLocation" id="locationpicker" class="modal-btn date-wrapper" autocomplete="off" style="position: absolute; display: block; visibility: visible; width: 100%; opacity: 0; z-index: 2;">
                        <button type="button" class="modal-btn date-wrapper">
                            <span class="modal-subtitle location">지역</span>
                            <div class="modal-form-content select-box">
                                <!-- 지역 선택 -->
                                <select  class="modal-select modal-selectbox" name="sido1" id="sido1"></select>
                                <select  class="modal-select modal-selectbox" name="gugun1" id="gugun1"></select>
                                <!-- 지역 선택 끝 -->
                            </div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <!-- 푸터 -->
        <div class="modal-footer-wrapper">
            <footer>
                <button type="button" class="modal-clear-btn">
                    <p>검색 초기화</p>
                </button>
                <button type="button" class="modal-search-btn">
                        <span class="modal-span-wrapper">
                            <div class="modal-search-wrapper">
                                <div class="modal-search-img">
                                    <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="presentation" focusable="false" style="display: block; height: 16px; width: 16px; fill: #fff;">
                                        <path d="M13 0c7.18 0 13 5.82 13 13 0 2.868-.929 5.519-2.502 7.669l7.916 7.917-2.828 2.828-7.917-7.916A12.942 12.942 0 0 1 13 26C5.82 26 0 20.18 0 13S5.82 0 13 0zm0 4a9 9 0 1 0 0 18 9 9 0 0 0 0-18z" opacity=".8"></path>
                                    </svg>
                                </div>
                                <p class="modal-search-name" style="color: #fff !important;">
                                    검색
                                </p>
                            </div>
                        </span>
                </button>
            </footer>
        </div>
    </div>
</div>
<!--&lt;!&ndash;모달 &ndash;&gt;-->
<!--<div th:insert="~{/modal/mobile/search-modal :: search-modal}"></div>-->
<!--&lt;!&ndash;모달 &ndash;&gt;-->
</body>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
<script th:inline="javascript">
    let applies = [[${applies}]];
    let memberId = [[${session.memberId}]];
    let nextPage = 0;
    // let applys = [[${applys}]];
    // applys는 ajax로 받아와서 여기선 못가져오는게 맞나?
    // console.log("applys")
    // console.log(applys);

    // 요일 계산
    function changeToDate(date) {
        switch (date) {
            case 0:
                return "일";
                break;
            case 1:
                return "월";
                break;
            case 2:
                return "화";
                break;
            case 3:
                return "수";
                break;
            case 4:
                return "목";
                break;
            case 5:
                return "금";
                break;
            case 6:
                return "토";
                break;
            default:
                break;
        }
    }
    // let text = ""; // 초기화 선언
    // 목록 담는 메소드
    function showList(applies) {
        console.log("들어옴2@@@@@@@@@@@");
        console.log(applies.length);
        for (var i=0; i < applies.length; i++) {
            let text = "";
            // applies.forEach(apply => {
            // 이미 수락이 된 경우는 안뜨게 하고 수락이 되었더라도 베테랑 자신의 수강생이면 목록에 뜨게 해야함
            // console.log('apply.applyStatus');
            // console.log(apply.applyStatus);
            // console.log('apply.veteranMemberId');
            // console.log(apply.veteranMemberId);
            // console.log('MemberId');
            // console.log(memberId);

            if (applies[i].applyStatus == '0') {
                const nowDateWhole = new Date();

                const registerDateWhole = new Date(applies[i].applyRegisterDate);
                const registerYear = registerDateWhole.getFullYear();
                const registerMonth = registerDateWhole.getMonth() + 1;
                const registerDate = registerDateWhole.getDate();
                const registerDay = registerDateWhole.getDay();

                const applyDateWhole = new Date(applies[i].applyDate);
                const applyYear = applyDateWhole.getFullYear();
                const applyMonth = applyDateWhole.getMonth() + 1;
                const applyDate = applyDateWhole.getDate();
                const applyDay = applyDateWhole.getDay();

                const updateTime = nowDateWhole.getTime() - registerDateWhole.getTime();
                updateTime2 = updateTime / (1000 * 60 * 60 * 24);

                // console.log("updateTime");
                // console.log(updateTime2);

                const memberDriveRegisterDateWhole = new Date(applies[i].memberDriveRegisterDate);
                // console.log(memberDriveRegisterDateWhole);

                const drivingTime = nowDateWhole.getTime() - memberDriveRegisterDateWhole.getTime();
                drivingTime2 = new Date(drivingTime);
                drivingTime2 = drivingTime2.getTime() / (1000 * 60 * 60 * 24 * 365.25);
                // console.log("총 운전 경력");
                // console.log(drivingTime2);
                // console.log(Math.floor(drivingTime2));
                // console.log(drivingTime2.getTime() / (1000 * 60 * 60 * 24 * 365.25));

                const remainingTime = applyDateWhole.getTime() - nowDateWhole.getTime();
                // console.log(remainingTime);
                remainingTime2 = new Date(remainingTime);
                remainingTime2 = remainingTime2.getTime() / (1000 * 60 * 60 * 24);
                // console.log(remainingTime2);
                // console.log(remainingTime2.getDate() - 1);
                if (remainingTime2 <= 0){
                    continue;
                }
                text += `
			            <div class="result-beginner">
                            <div class="project-status-label">
                                <div class="status-mark recruiting-mark">신청중</div>
                            `;
                // 요청한지 1일이 지났으면 new 안뜨고 1일 이하면 new 부분이 뜸
                if (updateTime2 <= 1) {
                    text += `<div class="status-mark new-mark">NEW</div>`;
                }

                text += `
                            </div>
                            <div class="beginner-title">
                                <span class="subtitle">
                                    ${applyYear}.${applyMonth}.${applyDate}(${changeToDate(applyDay)})
                                </span>
                            </div>
                            <div class="beginner-info-box">
                                <div class="estimated-box">
                                    <div class="estimated estimated-point">
                                         <p class="estimated-help-text">
                                            예상 포인트
                                         </p>
                                         <p class="estimated-value">
                                            ${applies[i].applyCourse == "A" ? "50,000" : "100,000"}
                                         </p>
                                    </div>
                                    <div class="estimated estimated-term">
                                        <p class="estimated-help-text">
                                            남은 기간
                                         </p>
                                         <p class="estimated-value">
                                            ${remainingTime2 < 0 ? 0 : Math.ceil(remainingTime2)}일
                                         </p>
                                    </div>
                                </div>
                                <div class="category-field-box">
                                    <p class="category-info">
                                        코스
                                    </p>
                                    <div class="pipe"></div>
                                    <p class="field-info">
                                        <span>${applies[i].applyCourse}</span>코스(시내주행)
                                    </p>
                                </div>
                                <div class="license-info-tag">
                                    <div class="simple-chip">
                                        초보자
                                    </div>
                                    <div class="pipe"></div>
                                    <div class="driver-info-box">
                            `;

                if (drivingTime2 >= 1) {
                    text += `
                                        <div class="driver-tag">${Math.floor(drivingTime2)}년차</div>
                                        `;
                } else {
                    text += `
                                        <div class="driver-tag">1년 미만</div>
                                        `;

                }

                if (drivingTime2 > 5) {
                    text += `
                                <div class="driver-tag">장롱</div>
                            `;
                } else {
                    text += `
                                 <div class="driver-tag">신입</div>
                            `;
                }
                text += `
                                    </div>
                                </div>
                                <div class="driver-info-etc">
                                    <div class="location-tag">
                                        <span class="driver-location">
                                            ${applies[i].applyLocation}
                                        </span>
                                    </div>
                                    <div class="pipe"></div>
                                    <div class="register-date">
                                        <span>등록일자 </span><span>${registerYear}.${registerMonth}.${registerDate}(${changeToDate(registerDay)})</span>
                                    </div>
                                </div>
                            </div>
                            <div class="ok-wrapper">
                        `;

                if (applies[i].applyStatus == 0) {
                    text += `
                                <button type="button" class="ok-btn" onclick="acceptOrReject(this)">수락</button>
                                <input type="hidden" value="${applies[i].applyId}">
                                `;
                } else {
                    text += `
                                <button type="button" class="no-btn" onclick="acceptOrReject(this)">거절</button>
                                <input type="hidden" value="${applies[i].applyId}">
                                `;
                }

                text += `
                            </div>
                        </div>
			            `;
            } else if (applies[i].applyStatus == '1' && memberId == applies[i].veteranMemberId) {
                const nowDateWhole = new Date();

                const registerDateWhole = new Date(applies[i].applyRegisterDate);
                const registerYear = registerDateWhole.getFullYear();
                const registerMonth = registerDateWhole.getMonth() + 1;
                const registerDate = registerDateWhole.getDate();
                const registerDay = registerDateWhole.getDay();

                const applyDateWhole = new Date(applies[i].applyDate);
                const applyYear = applyDateWhole.getFullYear();
                const applyMonth = applyDateWhole.getMonth() + 1;
                const applyDate = applyDateWhole.getDate();
                const applyDay = applyDateWhole.getDay();

                const updateTime = nowDateWhole.getTime() - registerDateWhole.getTime();
                updateTime2 = updateTime / (1000 * 60 * 60 * 24);

                // console.log("updateTime");
                // console.log(updateTime2);

                const memberDriveRegisterDateWhole = new Date(applies[i].memberDriveRegisterDate);
                // console.log(memberDriveRegisterDateWhole);

                const drivingTime = nowDateWhole.getTime() - memberDriveRegisterDateWhole.getTime();
                drivingTime2 = new Date(drivingTime);
                drivingTime2 = drivingTime2.getTime() / (1000 * 60 * 60 * 24 * 365.25);
                // console.log("총 운전 경력");
                // console.log(drivingTime2);
                // console.log(Math.floor(drivingTime2));
                // console.log(drivingTime2.getTime() / (1000 * 60 * 60 * 24 * 365.25));

                const remainingTime = applyDateWhole.getTime() - nowDateWhole.getTime();
                // console.log(remainingTime);
                remainingTime2 = new Date(remainingTime);
                remainingTime2 = remainingTime2.getTime() / (1000 * 60 * 60 * 24);
                // console.log(remainingTime2);
                // console.log(remainingTime2.getDate() - 1);
                if (remainingTime2 <= 0){
                    continue;
                }
                text += `
			            <div class="result-beginner">
                            <div class="project-status-label">
                                <div class="status-mark recruiting-mark">신청중</div>
                            `;
                // 요청한지 1일이 지났으면 new 안뜨고 1일 이하면 new 부분이 뜸
                if (updateTime2 <= 1) {
                    text += `<div class="status-mark new-mark">NEW</div>`;
                }

                text += `
                            </div>
                            <div class="beginner-title">
                                <span class="subtitle">
                                    ${applyYear}.${applyMonth}.${applyDate}(${changeToDate(applyDay)})
                                </span>
                            </div>
                            <div class="beginner-info-box">
                                <div class="estimated-box">
                                    <div class="estimated estimated-point">
                                         <p class="estimated-help-text">
                                            예상 포인트
                                         </p>
                                         <p class="estimated-value">
                                            ${applies[i].applyCourse == "A" ? "50,000" : "100,000"}
                                         </p>
                                    </div>
                                    <div class="estimated estimated-term">
                                        <p class="estimated-help-text">
                                            남은 기간
                                         </p>
                                         <p class="estimated-value">
                                            ${remainingTime2 < 0 ? 0 : Math.ceil(remainingTime2)}일
                                         </p>
                                    </div>
                                </div>
                                <div class="category-field-box">
                                    <p class="category-info">
                                        코스
                                    </p>
                                    <div class="pipe"></div>
                                    <p class="field-info">
                                        <span>${applies[i].applyCourse}</span>코스(시내주행)
                                    </p>
                                </div>
                                <div class="license-info-tag">
                                    <div class="simple-chip">
                                        초보자
                                    </div>
                                    <div class="pipe"></div>
                                    <div class="driver-info-box">
                            `;

                if (drivingTime2 >= 1) {
                    text += `
                                        <div class="driver-tag">${Math.floor(drivingTime2)}년차</div>
                                        `;
                } else {
                    text += `
                                        <div class="driver-tag">1년 미만</div>
                                        `;

                }
                if (drivingTime2 > 5) {
                    text += `
                                <div class="driver-tag">장롱</div>
                            `;
                } else {
                    text += `
                                 <div class="driver-tag">신입</div>
                            `;
                }
                text += `
                                    </div>
                                </div>
                                <div class="driver-info-etc">
                                    <div class="location-tag">
                                        <span class="driver-location">
                                            ${applies[i].applyLocation}
                                        </span>
                                    </div>
                                    <div class="pipe"></div>
                                    <div class="register-date">
                                        <span>등록일자 </span><span>${registerYear}.${registerMonth}.${registerDate}(${changeToDate(registerDay)})</span>
                                    </div>
                                </div>
                            </div>
                            <div class="ok-wrapper">`;

                if (applies[i].applyStatus == 0) {
                    text += `
                                        <button type="button" class="ok-btn" onclick="acceptOrReject(this)">수락</button>
                                        <input type="hidden" value="${applies[i].applyId}">
                                        `;
                } else {
                    text += `
                                        <button type="button" class="no-btn" onclick="acceptOrReject(this)">거절</button>
                                        <input type="hidden" value="${applies[i].applyId}">
                                        `;
                }
                text += `
                            </div>
                        </div>
			`;
            }
            $(".result-beginners").append(text);
        }
        // });
    }

    /*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*/
    //    추가된 코드
    const fetchData = () => {
        console.log("들어옴@@@@@@@@");
        // nowDateWhole <- 현재시간
        // registerDateWhole <- 등록일자
        // applyDateWhole <- 클라이언트가 연수를 요청한 날
        // drivingTime2 <- 운전 경력 계산 | 운전 경력 년으로 표현
        // remainingTime2 <- 현재 시간 - 클라이언트가 연수를 요청한 날 | 남은 시간 일수로 표현
        // updateTime2 <- 현재 시간 - 연수 신청 등록시간 | 남은 시간 일수로 표현

        // showList(applies); // 초기 값으로 목록 불러오기

        // let currentPage = parseInt($('#current-page').val());
        nextPage++;
        console.log("ajax위 들어옴");
        // let currentPage = parseInt($('#current-page').val());
        // let nextPage = currentPage + 1;
        // console.log("currentPage : " + currentPage);
        console.log("nextPage : " + nextPage);
        $.ajax({
            type: 'GET',
            url: `/applies/list-mobiles/${nextPage}`,
            success: function (result) {
                console.log(result);
                // $('#current-page').val(nextPage);    // 통통 튈때 추가하면 이유는 모르지만 통통 안튀김
                showList(result); // 새로운 값을 담기
            },
            error: function (error) {
                console.log('Error fetching data:', error);
            }
        });
    };

    $(document).ready(function () {
        fetchData();
        // 목록 불러올 때 조건식에 막혀서 4개 이하로 가져오면 스크롤 길이가 부족해서 무한 스크롤 기능이 막혀버림
        // 해결하기 위해 가져온 목록이 3개 이하면 한번 더 데이터를 뿌려 줌
        if ($(".result-beginners").children().length < 4){
            fetchData();
        }
    });
    //    원래 코드
    $(window).scroll(function () {
        // if ($(window).scrollTop() + $(window).height() >= $(document).height()) {
        // console.log($(window).scrollTop());
        // console.log($(document).height());
        // console.log($(window).height());
        // console.log($(document).height() - $(window).height());
        // console.log(Math.ceil($(window).scrollTop()));
        if(Math.ceil($(window).scrollTop()) == $(document).height() - $(window).height()){
            fetchData();
        }
    });
</script>
<script src="/js/modal/mobile/search-modal.js"></script>
<script src="/js/mobile/list.js"></script>
</html>
